# Домашнее задание к занятию «Индексы» Яковлев Д.А



### Задание 1

Напишите запрос к учебной базе данных, который вернёт процентное отношение общего размера всех индексов к общему размеру всех таблиц.

Решение:

```sql
SELECT ROUND((SUM(index_length) / (SUM(data_length) + SUM(index_length))) * 100, 2) AS '% общего размера индексов к общему ращмеру всех таблиц', SUM(index_length) AS 'Общий размер всех индексов', SUM(data_length)+SUM(index_length) AS 'Общий размер всех таблиц'
FROM information_schema.tables
WHERE information_schema.tables.table_schema = 'sakila';

```

![alt text](https://github.com/NorthernWarrior88/sys-pattern-homework/blob/patch-1/%D0%91%D0%B5%D0%B7%20%D0%B8%D0%BC%D0%B5%D0%BD%D0%B8.png)


### Задание 2

Выполните explain analyze следующего запроса:
```sql
select distinct concat(c.last_name, ' ', c.first_name), sum(p.amount) over (partition by c.customer_id, f.title)
from payment p, rental r, customer c, inventory i, film f
where date(p.payment_date) = '2005-07-30' and p.payment_date = r.rental_date and r.customer_id = c.customer_id and i.inventory_id = r.inventory_id
```
- перечислите узкие места;
- оптимизируйте запрос: внесите корректировки по использованию операторов, при необходимости добавьте индексы.

  Решение:

До оптимизации:

![alt text](https://github.com/NorthernWarrior88/sys-pattern-homework/blob/main/3.png)
  
 После анализа исходного запроса было выявлено, что основным узким местом является подключение избыточных таблиц, таких как inventory, rental и film. Эти таблицы не несут полезной нагрузки для расчёта суммы платежей клиентов за определённую дату, так как их данные не используются в итоговых вычислениях. Их исключение из запроса позволит сократить время выполнения и снизить нагрузку на систему.

Кроме того, использование оператора DISTINCT требует выполнения сортировки и удаления дубликатов, что может быть ресурсоёмким, особенно при работе с большими объёмами данных. Также стоит учитывать, что оконные функции, хотя и мощные, могут быть затратными по времени и ресурсам при обработке крупных наборов данных.

Для оптимизации запроса всю необходимую информацию можно получить только из таблиц payment и customer, что упростит логику запроса и повысит его производительность.



Код после оптимизации:

```sql
EXPLAIN ANALYZE
SELECT concat(c.last_name, ' ', c.first_name) AS customers, SUM(p.amount)
FROM customer c
JOIN rental r ON c.customer_id = r.customer_id 
JOIN payment p ON r.rental_date = p.payment_date WHERE date(p.payment_date) = '2005-07-30'
GROUP BY c.customer_id; 
```
![alt text](https://github.com/NorthernWarrior88/sys-pattern-homework/blob/main/4.png)

